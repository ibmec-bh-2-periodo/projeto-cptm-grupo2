<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa CPTM</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <style>
    /* Reset geral */
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    #map {
      width: 100vw;
      height: 100vh;

    }

    /* Melhorar a fonte do popup para mobile */
    .leaflet-popup-content {
      font-size: 18px;
      text-align: center;
      max-height: 110px;
      overflow-y: auto;
    }

    /* Popup estilizado */
    .popup-box {
    font-family: "Inter", sans-serif;
    padding: 8px;
    }

    .popup-titulo {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 4px;
    color: whitesmoke;
    text-align: center;
    padding-top: 10px;
    padding-bottom: 10px;
    margin-bottom: 20px;
    }

    .popup-linhas {
    font-size: 16px;
    color: #444;
    margin-bottom: 6px;
    text-align: center;
    margin-bottom: 20px;
    }

    .popup-status {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-weight: bold;
    }

    .popup-status.red .texto {
        color: #b30000;
        font-size: 20px;
    }

    .popup-status.green .texto {
        color: #1a7f3c;
        font-size: 20px;
    }

    .popup-status.orange .texto {
        color: #ff9800;
        font-size: 20px;
    }

    .bolinha {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    display: inline-block;
    }

    .bolinha.red {
    background-color: #b30000;
    }

    .bolinha.orange {
    background-color: #ff9800;
    }

    .bolinha.green {
    background-color: #1a7f3c;
    }

    .popup-descricao {
    margin-top: 20px;
    font-size: 14px;
    color: #444;
    text-align: left;
    line-height: 1.3;
    margin: 10px;
    }

    .linha-vermelha  { 
        background-color: #BF2A61; 
        border-radius: 10px;
    }
    .linha-diamante    { 
      background-color: #8E8D81;
      border-radius: 10px; 
    }
    .linha-esmeralda      { 
      background-color: #038C8C;
      border-radius: 10px;
     }
    .linha-turquesa   { 
      background-color: #0C80BB;
      border-radius: 10px;
     }
    .linha-coral     { 
      background-color: #F26B5E;
      border-radius: 10px;
     }
    .linha-safira    { 
      background-color: #222E73;
      border-radius: 10px;
     }
   

    .modal {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 0;
        width: 100%;
        max-width: 80vh;
        background-color: #fff;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        transform: translateY(100%);
        transition: transform 0.3s ease;
        overflow-y: auto;
        z-index: 1000;

    }

    .modal.active {
    transform: translateY(0);
    }

    #map {
        width: 100vw;
        height: 100vh;
        transition: 0.3s ease;
    }

    #map.reduzido {
    height: 60vh !important;
    }

    .modal-content {
    padding: 16px;
    font-family: "Inter", sans-serif;
    }

    .modal-drag-handle {
    width: 40px;
    height: 5px;
    background-color: #7e7e7e;
    border-radius: 3px;
    margin: -5px auto 12px auto;
    touch-action: none;
    }

  </style>
</head>

<body>

<div id="map"></div>
<div id="estacaoModal" class="modal">
    <div class="modal-content" id="modalContent">
        <div class="modal-drag-handle" id="dragHandle"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // Criar o mapa
  var map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: 0,
      maxZoom: 1,
      dragging: true,
      maxBoundsViscosity: 1.0,
      tapTolerance: 30, // tolerância para toque no mobile
      zoomControl: false // opcional: remove os botões + e -
  });

  var bounds = [[0,0], [768,1189]]; // altura x largura da imagem
  var image = L.imageOverlay('./assets/img/cptm-map.png', bounds).addTo(map);

  map.fitBounds(bounds);
  map.setMaxBounds(bounds);

  // Função para determinar a demanda com base no horário atual
  function obterStatusDemanda() {
    const hora = new Date().getHours();

    if ((hora >= 6 && hora < 9) || (hora >= 16 && hora < 20)) {
      return { texto: "Alta demanda", cor: "red"};
    } else if (hora >= 20 && hora < 22) {
      return { texto: "Demanda média", cor: "orange"};
    } else {
      return { texto: "Baixa demanda", cor: "green"};
    }
  }

  // Pega status atual da demanda
  const demanda = obterStatusDemanda();

  function adicionarEstacao(lat, lng, nome, linhas, descricao, corClasse) {
  const demanda = obterStatusDemanda();

  const popupHtml = `
    <div class="popup-box">
      <div class="popup-titulo ${corClasse}">${nome}</div>
      <div class="popup-linhas">${linhas}</div>
      <div class="popup-status ${demanda.cor}">
        <span class="texto ${demanda.cor}">${demanda.texto}</span>
        <span class="bolinha ${demanda.cor}"></span>
      </div>
      <div class="popup-descricao">${descricao || ""}</div>
    </div>
  `;

  const marcador = L.circleMarker([lat, lng], {
    radius: 10,
    color: 'transparent',
    fillColor: 'transparent',
    fillOpacity: 0
  }).addTo(map);

  marcador.on('click', function () {
    map.panTo([lat, lng], { animate: true });
    mostrarModal(nome, linhas, descricao, corClasse, demanda);
  });

}

const modal = document.getElementById("estacaoModal");
const content = document.getElementById("modalContent");

function mostrarModal(nome, linhas, descricao, corClasse, demanda) {
  content.innerHTML = `
    <div class="modal-drag-handle"></div>
    <div class="popup-titulo ${corClasse}">${nome}</div>
    <div class="popup-linhas">${linhas}</div>
    <div class="popup-status ${demanda.cor}">
      <span class="texto ${demanda.cor}">${demanda.texto}</span>
      <span class="bolinha ${demanda.cor}"></span>
    </div>
    <div class="popup-descricao">${descricao || ""}</div>
  `;

  modal.style.transform = "translateY(0)"; // garante que o modal volte pro topo
  modal.classList.add("active");
  document.getElementById("map").classList.add("reduzido");
}

// Eventos de toque para o modal inteiro
let startY = 0;
let currentY = 0;
let dragging = false;

modal.addEventListener("touchstart", function (e) {
  if (e.touches.length !== 1) return;
  startY = e.touches[0].clientY;
  dragging = true;
  modal.style.transition = "none";
});

modal.addEventListener("touchmove", function (e) {
  if (!dragging) return;
  currentY = e.touches[0].clientY;
  const delta = currentY - startY;
  if (delta > 0) {
    modal.style.transform = `translateY(${delta}px)`;
  }
});

modal.addEventListener("touchend", function () {
  dragging = false;
  modal.style.transition = "transform 0.3s ease";

  if (currentY - startY > 10) {
    fecharModal();
  } else {
    modal.style.transform = `translateY(0)`;
  }

  startY = 0;
  currentY = 0;
});

function fecharModal() {
  modal.classList.remove("active");
  modal.style.transform = "translateY(100%)";
  document.getElementById("map").classList.remove("reduzido");
}

// Fechar ao clicar fora do conteúdo
modal.addEventListener("click", function (e) {
  if (e.target === this) {
    fecharModal();
  }
});


adicionarEstacao(503.4440865705644, 666.5, "Luz", "Linha 11 - Coral (Expresso Leste)", "Nos horários de pico, o intervalo entre trens é de cerca de 4 minutos. Fora do pico, os intervalos variam de 8 a 12 minutos.", "linha-coral");
adicionarEstacao(485.5, 646.5, "Luz", "Linha 7 - Rubi", "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.", "linha-vermelha");
adicionarEstacao(485.5, 589.5, "Palmeiras-Barra Funda", "Linha 7 - Rubi", "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.", "linha-vermelha")
adicionarEstacao(485, 563.5, "Água Branca", "Linha 7 - Rubi",  "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.", "linha-vermelha");
adicionarEstacao(485, 541.5, "Lapa", "Linha 7 - Rubi",  "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao(506.5, 517.5, "Piqueri", "Linha 7 - Rubi",  "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao(517.915746887152, 508.5, "Pirituba", "Linha 7 - Rubi",  "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao(525.944744265388, 501.4348978824872, "Vila Clarice", "Linha 7 - Rubi",  "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao( 543, 494.5, "Jaraguá", "Linha 7 - Rubi",  "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao(556.4516512322144, 485.4490505167291, "Vila Aurora", "Linha 7 - Rubi",  "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao( 572, 477, "Perus", "Linha 7 - Rubi",  "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao( 581, 466, "Caieiras", "Linha 7 - Rubi",  "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao( 593, 458.5, "Franco da Rocha", "Linha 7 - Rubi", "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao( 608, 447.5, "Baltazar Fidelis", "Linha 7 - Rubi", "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao( 624, 423, "Francisco Morato", "Linha 7 - Rubi", "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao( 634, 431, "Francisco Morato", "Linha 7 - Rubi", "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao( 637.5, 414.5, "Botujuru", "Linha 7 - Rubi", "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao( 651.5, 405, "Campo Limpo Paulista", "Linha 7 - Rubi", "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao( 666.0028084370949, 394.5, "Várzea Paulista", "Linha 7 - Rubi", "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");
adicionarEstacao(  682.5, 383.5, "Jundiaí", "Linha 7 - Rubi", "Nos horários de pico, os intervalos entre os trens são mais curtos, variando de 4 a 6 minutos. Fora do horário de pico, os intervalos podem ser de até 15 minutos.","linha-vermelha");

  // Ativar modo debug para encontrar coordenadas de outras estações
  // map.on('click', function(e) {
  //   alert("Coordenadas: " + e.latlng.lat + ", " + e.latlng.lng);
  // });

</script>

</body>
</html>